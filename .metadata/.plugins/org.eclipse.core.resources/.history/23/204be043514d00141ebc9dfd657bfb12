package raphaelpantaleao.bankocr.tests.endtoend;

import static org.hamcrest.Matchers.equalTo;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.StringReader;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

import javax.swing.JButton;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JTextArea;

import org.hamcrest.FeatureMatcher;
import org.hamcrest.Matcher;

import com.objogate.exception.Defect;
import com.objogate.wl.Prober;
import com.objogate.wl.swing.AWTEventQueueProber;
import com.objogate.wl.swing.ComponentSelector;
import com.objogate.wl.swing.driver.JButtonDriver;
import com.objogate.wl.swing.driver.JFileChooserDriver;
import com.objogate.wl.swing.driver.JFrameDriver;
import com.objogate.wl.swing.driver.JLabelDriver;
import com.objogate.wl.swing.driver.JTextComponentDriver;
import com.objogate.wl.swing.gesture.GesturePerformer;

@SuppressWarnings("unchecked")
public class BankOCRDriver extends JFrameDriver {

	private static final ComponentSelector<JFrame> topLevelFrame = topLevelFrame(
			named("Bank OCR"), showingOnScreen());

	private static Prober eventQueueProberWith(final int timeoutMillis) {
		return new AWTEventQueueProber(timeoutMillis, 100);
	}

	public BankOCRDriver(final int aTimeoutInMillis) {
		super(new GesturePerformer(), topLevelFrame,
				eventQueueProberWith(aTimeoutInMillis));
	}

	public void hasTitle(String titleName) {
		this.hasTitle(equalTo(titleName));
	}

	public void hasALabelWith(String labelName, String text) {
		new JLabelDriver(this, named(labelName)).hasText(equalTo(text));
	}

	public void hasAButtonWith(String name, String text) {
		new JButtonDriver(this, JButton.class, named(name), enabled(true))
				.hasText(equalTo(text));
	}

	public void hasAButtonWith(String name) {
		new JButtonDriver(this, JButton.class, named(name)).is(enabled(true));
	}

	public void hasADisabledButtonWith(String name, String text) {
		new JButtonDriver(this, JButton.class, named(name), enabled(false))
				.hasText(equalTo(text));
	}

	public void hasATextAreaWith(String textAreaName, String text, int rows,
			int columns) {
		new JTextComponentDriver<JTextArea>(this, JTextArea.class,
				named(textAreaName), numberOfRowsIs(rows),
				numberOfColumnsIs(columns), isReadOnly())
				.hasText(equalTo(text));
	}

	public void openFileDialog() {
		File scannedFile = prepareTmpFileFor("  _  _     _  _  _  _  _ \n"
				+ "| _| _||_||_ |_   ||_||_|\n" + "||_  _|  | _||_|  ||_| _|\n");
		JFileChooserDriver jFileChooserDriver = new JFileChooserDriver(this,
				named("file chooser"));
		jFileChooserDriver.enterManually(scannedFile.getAbsolutePath());
		jFileChooserDriver.approve();
	}

	private File prepareTmpFileFor(String aString) {
		final String tmpdir = System.getProperty("java.io.tmpdir");
		final File tmpDir = new File(tmpdir);
		final String scan = aString;
		File scannedFile = new File(tmpDir, "scan.txt");
		try (FileWriter fileWriter = new FileWriter(scannedFile)) {
			fileWriter.write(scan);
		}

		return scannedFile;
	}

	private Matcher<? super JTextArea> numberOfColumnsIs(int columns) {
		String expectedText = "JTextArea with number of columns";
		String actualValueText = "number of columns";
		return createJTextAreaMatcher(columns, "getColumns", expectedText,
				actualValueText);
	}

	private Matcher<? super JTextArea> isReadOnly() {
		return createJTextAreaMatcher(false, "isEditable",
				"JTextArea editable property", "editable property");

	}

	private Matcher<? super JButton> enabled(boolean enabled) {
		return new FeatureMatcher<JButton, Boolean>(equalTo(enabled),
				"Jbutton enable property", "enable property") {
			protected Boolean featureValueOf(JButton jbutton) {
				return jbutton.isEnabled();
			};
		};
	}

	private Matcher<? super JTextArea> numberOfRowsIs(int rows) {
		String expectedText = "JTextArea with number of rows";
		String actualValueText = "number of rows";
		return createJTextAreaMatcher(rows, "getRows", expectedText,
				actualValueText);
	}

	private <T> Matcher<? super JTextArea> createJTextAreaMatcher(T object,
			String methodName, String expectedText, String actualValueText) {

		return new FeatureMatcher<JTextArea, T>(equalTo(object), expectedText,
				actualValueText) {

			@Override
			protected T featureValueOf(JTextArea textArea) {
				Method method = null;
				try {
					method = JTextArea.class.getMethod(methodName);
					return (T) method.invoke(textArea);
				} catch (IllegalAccessException | IllegalArgumentException
						| InvocationTargetException | NoSuchMethodException
						| SecurityException e) {
					throw new Defect("Could not invoke method "
							+ method.getName() + ".", e);
				}

			}
		};
	}

	public void performsAActionWith(String buttonName) {
		new JButtonDriver(this, JButton.class, named(buttonName)).click();
	}
}
